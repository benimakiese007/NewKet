<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Vendeur | NewKet</title>
    <link rel="stylesheet" href="css/tailwind.css">
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/supabase-adapter.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: #f9fafb;
        }

        .glass-panel {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1.5rem;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            color: #6b7280;
            transition: all 0.2s;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background: #f3f4f6;
            color: #111827;
            font-weight: 600;
        }

        .sidebar-link.active {
            background: #000000;
            color: white;
        }
    </style>
    <script>
        const role = localStorage.getItem('newketRole');
        if (!role || role !== 'supplier') {
            window.location.href = 'index.html';
        }
    </script>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23000' d='m12 17.27l4.15 2.51c.76.46 1.69-.22 1.49-1.08l-1.1-4.72l3.67-3.18c.67-.58.31-1.68-.57-1.75l-4.83-.41l-1.89-4.46c-.34-.81-1.5-.81-1.84 0L9.19 8.63l-4.83.41c-.88.07-1.24 1.17-.57 1.75l3.67 3.18l-1.1 4.72c-.2.86.73 1.54 1.49 1.08l4.15-2.51Z'/></svg>">
</head>

<body class="text-gray-900 antialiased">
    <div id="header-placeholder"></div>


    <div class="max-w-7xl mx-auto px-4 sm:px-6 pt-24 pb-12 flex flex-col md:flex-row gap-8">
        <!-- Sidebar -->
        <aside class="w-full md:w-64 flex-shrink-0">
            <div class="glass-panel p-6 sticky top-24">
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-xl"></div>
                    <div>
                        <h2 class="font-bold text-gray-900" id="vendorName">Ma Boutique</h2>
                        <p class="text-[10px] font-black uppercase tracking-widest text-gray-400">Vendeur Premium</p>
                    </div>
                </div>
                <nav class="space-y-1">
                    <a href="#" onclick="switchVendorTab('dashboard')" class="sidebar-link active">
                        <iconify-icon icon="solar:chart-square-bold" width="20"></iconify-icon>
                        Tableau de bord
                    </a>
                    <a href="publish.html" class="sidebar-link">
                        <iconify-icon icon="solar:add-circle-bold" width="20"></iconify-icon>
                        Publier
                    </a>
                    <a href="#" onclick="switchVendorTab('products')" class="sidebar-link">
                        <iconify-icon icon="solar:box-bold" width="20"></iconify-icon>
                        Mes Produits
                    </a>
                    <a href="#" onclick="switchVendorTab('gains')" class="sidebar-link">
                        <iconify-icon icon="solar:wallet-2-bold" width="20"></iconify-icon>
                        Ventes & Gains
                    </a>
                    <a href="#" onclick="switchVendorTab('settings')" class="sidebar-link">
                        <iconify-icon icon="solar:settings-bold" width="20"></iconify-icon>
                        Paramètres
                    </a>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 space-y-8">
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight">Bonjour, <span id="vendorDisplay">Vendeur</span></h1>
                    <p class="text-gray-500 mt-1">Voici un aperçu de l'activité de votre boutique aujourd'hui.</p>
                </div>
                <a href="publish.html"
                    class="bg-black text-white px-6 py-3 rounded-2xl font-bold text-sm hover:shadow-xl transition-all">Ajouter
                    un produit</a>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-panel p-8">
                    <p class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-2">Ventes totales</p>
                    <div class="text-3xl font-black text-gray-900" id="vendorTotalSales">0 FC</div>
                    <p class="text-xs text-green-500 mt-2 font-bold">+0% ce mois</p>
                </div>
                <div class="glass-panel p-8">
                    <p class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-2">Commandes</p>
                    <div class="text-3xl font-black text-gray-900" id="vendorOrders">0</div>
                    <p class="text-xs text-gray-400 mt-2 font-bold font-medium pt-1">0 en attente</p>
                </div>
                <div class="glass-panel p-8">
                    <p class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-2">Produits en ligne</p>
                    <div class="text-3xl font-black text-gray-900" id="vendorProducts">0</div>
                    <p class="text-xs text-blue-500 mt-2 font-bold">Actifs sur NewKet</p>
                </div>
            </div>

            <!-- Charts & Tables Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8" id="tab-dashboard">
                <!-- Sales Chart -->
                <div class="glass-panel p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-gray-900">Évolution des ventes</h3>
                        <div
                            class="text-[10px] font-bold text-green-500 uppercase tracking-widest bg-green-50 px-2 py-1 rounded-md">
                            Direct</div>
                    </div>
                    <div class="aspect-[16/9]">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                <!-- Recent Orders Table -->
                <div class="glass-panel p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-gray-900">Commandes Récentes</h3>
                        <a href="#"
                            class="text-xs font-bold text-gray-400 hover:text-black transition-colors uppercase tracking-widest">Voir
                            tout</a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr
                                    class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 border-b border-gray-50">
                                    <th class="pb-4">Commande</th>
                                    <th class="pb-4">Client</th>
                                    <th class="pb-4">Contact</th>
                                    <th class="pb-4">Total</th>
                                    <th class="pb-4">Statut</th>
                                </tr>
                            </thead>
                            <tbody id="vendor-recent-orders" class="divide-y divide-gray-50">
                                <!-- Injected by JS -->
                                <tr>
                                    <td colspan="4" class="py-8 text-center text-sm text-gray-400">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Activity (New for Vendor) -->
                <div class="glass-panel p-8 lg:col-span-2">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-gray-900">Activités Récentes de la Boutique</h3>
                        <iconify-icon icon="solar:history-bold" width="20" class="text-gray-300"></iconify-icon>
                    </div>
                    <div id="vendor-activity-feed" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Products Management Tab (Hidden by default) -->
            <div id="tab-products" class="hidden">
                <div class="glass-panel p-8">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-xl font-bold">Mes Produits en Ligne</h2>
                        <div class="flex gap-2">
                            <input type="text" placeholder="Rechercher..."
                                class="text-sm px-4 py-2 bg-gray-50 border border-gray-100 rounded-xl outline-none focus:border-black transition-all">
                        </div>
                    </div>
                    <div id="vendor-products-grid"
                        class="product-grid grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-4 sm:gap-6">
                        <!-- Products injected here -->
                    </div>
                </div>
            </div>

            <!-- Gains Tab (Hidden by default) -->
            <div id="tab-gains" class="hidden">
                <div class="glass-panel p-8">
                    <h2 class="text-xl font-bold mb-8">Mes Gains & Paiements</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div class="bg-black text-white p-8 rounded-3xl">
                            <p class="text-[10px] font-black uppercase tracking-widest opacity-60 mb-2">Solde disponible
                            </p>
                            <div class="text-4xl font-black mb-6" id="gains-available">0 FC</div>
                            <button onclick="openWithdrawalModal()"
                                class="w-full bg-white text-black py-3 rounded-2xl font-bold hover:bg-gray-100 transition-all">Demander
                                un retrait</button>
                        </div>
                        <div class="space-y-4">
                            <div class="p-6 border border-gray-100 rounded-2xl flex justify-between items-center">
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase">Retraits en attente</p>
                                    <p class="font-bold" id="gains-pending">0 FC</p>
                                </div>
                                <iconify-icon icon="solar:clock-circle-bold" width="24"
                                    class="text-amber-500"></iconify-icon>
                            </div>
                            <div class="p-6 border border-gray-100 rounded-2xl flex justify-between items-center">
                                <div>
                                    <p class="text-xs font-bold text-gray-400 uppercase">Commission totale</p>
                                    <p class="font-bold" id="gains-commission">0 FC</p>
                                </div>
                                <iconify-icon icon="solar:tag-bold" width="24" class="text-gray-300"></iconify-icon>
                            </div>
                        </div>
                    </div>

                    <!-- Payout History -->
                    <div class="mt-12">
                        <h3 class="font-bold text-gray-900 mb-6">Historique des retraits</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr
                                        class="text-[10px] font-black uppercase tracking-widest text-gray-400 border-b border-gray-50">
                                        <th class="pb-4">Date</th>
                                        <th class="pb-4">Montant</th>
                                        <th class="pb-4">Méthode</th>
                                        <th class="pb-4">Statut</th>
                                    </tr>
                                </thead>
                                <tbody id="payout-history-body" class="divide-y divide-gray-50">
                                    <!-- Injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Withdrawal Modal -->
            <div id="withdrawalModal" class="fixed inset-0 z-[60] hidden">
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeWithdrawalModal()"></div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-4">
                    <div class="bg-white rounded-[2.5rem] p-8 shadow-2xl relative">
                        <button onclick="closeWithdrawalModal()"
                            class="absolute top-6 right-6 text-gray-400 hover:text-black transition-colors">
                            <iconify-icon icon="solar:close-circle-bold" width="32"></iconify-icon>
                        </button>

                        <h2 class="text-2xl font-black mb-2">Demander un retrait</h2>
                        <p class="text-gray-500 text-sm mb-8">Le montant sera versé sur votre compte Mobile Money.</p>

                        <div class="space-y-6">
                            <div>
                                <label
                                    class="block text-[10px] font-black uppercase tracking-widest text-gray-400 mb-2">Montant
                                    à retirer (FC)</label>
                                <input type="number" id="withdrawAmount" placeholder="Ex: 50000"
                                    class="w-full px-6 py-4 bg-gray-50 border border-transparent rounded-2xl outline-none focus:border-black font-bold text-lg transition-all">
                                <p class="text-[10px] text-gray-400 mt-2">Maximum disponible: <span
                                        id="maxAvailableWithdraw" class="font-bold text-black">0 FC</span></p>
                            </div>

                            <div>
                                <label
                                    class="block text-[10px] font-black uppercase tracking-widest text-gray-400 mb-2">Méthode
                                    de paiement</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="selectWithdrawMethod('M-Pesa')" id="btn-mpesa"
                                        class="withdraw-method-btn flex flex-col items-center gap-2 p-4 rounded-2xl border-2 border-gray-100 hover:border-black transition-all">
                                        <div
                                            class="w-10 h-10 rounded-full bg-[#E61C1F]/10 flex items-center justify-center">
                                            <span class="font-black text-[#E61C1F] text-xs">M</span>
                                        </div>
                                        <span class="text-xs font-bold">M-Pesa</span>
                                    </button>
                                    <button onclick="selectWithdrawMethod('Orange Money')" id="btn-orange"
                                        class="withdraw-method-btn flex flex-col items-center gap-2 p-4 rounded-2xl border-2 border-gray-100 hover:border-black transition-all">
                                        <div
                                            class="w-10 h-10 rounded-full bg-[#FF6600]/10 flex items-center justify-center">
                                            <span class="font-black text-[#FF6600] text-xs">O</span>
                                        </div>
                                        <span class="text-xs font-bold">Orange</span>
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label
                                    class="block text-[10px] font-black uppercase tracking-widest text-gray-400 mb-2">Numéro
                                    de téléphone</label>
                                <input type="tel" id="withdrawPhone" placeholder="0820000000"
                                    class="w-full px-6 py-4 bg-gray-50 border border-transparent rounded-2xl outline-none focus:border-black font-bold transition-all">
                            </div>

                            <button onclick="submitWithdrawal()" id="btnSubmitWithdrawal"
                                class="w-full bg-black text-white py-5 rounded-[1.5rem] font-bold text-base hover:shadow-2xl hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-3">
                                Confirmer la demande
                                <iconify-icon icon="solar:arrow-right-bold" width="20"></iconify-icon>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="footer-placeholder"></div>

            <script src="js/auth.js"></script>
            <script src="js/cart.js"></script>
            <script src="js/favorites.js"></script>
            <script src="js/currency.js"></script>
            <script src="js/products.js"></script>
            <script src="js/orders.js"></script>
            <script src="js/managers.js"></script>
            <script src="js/ui-helpers.js"></script>
            <script src="js/ui.js"></script>
            <script src="js/search.js"></script>
            <script src="js/main.js"></script>
            <script src="js/components-loader.js"></script>

            <script>
                let salesChart = null;
                let selectedWithdrawMethod = '';

                function switchVendorTab(tabId) {
                    // Tabs
                    document.getElementById('tab-dashboard').classList.add('hidden');
                    document.getElementById('tab-products').classList.add('hidden');
                    document.getElementById('tab-gains').classList.add('hidden');
                    document.getElementById('tab-settings').classList.add('hidden');

                    // Links
                    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));

                    if (tabId === 'dashboard') {
                        document.getElementById('tab-dashboard').classList.remove('hidden');
                        document.querySelector('a[onclick*="dashboard"]').classList.add('active');
                        renderVendorDashboard();
                    } else if (tabId === 'products') {
                        document.getElementById('tab-products').classList.remove('hidden');
                        document.querySelector('a[onclick*="products"]').classList.add('active');
                        renderVendorProducts();
                    } else if (tabId === 'gains') {
                        document.getElementById('tab-gains').classList.remove('hidden');
                        document.querySelector('a[onclick*="gains"]').classList.add('active');
                        renderVendorGains();
                    } else if (tabId === 'settings') {
                        document.getElementById('tab-settings').classList.remove('hidden');
                        document.querySelector('a[onclick*="settings"]').classList.add('active');
                    }
                }

                document.addEventListener('DOMContentLoaded', () => {
                    if (window.newketInitialized) {
                        initVendorDashboard();
                    } else {
                        window.addEventListener('newketInitialized', () => {
                            initVendorDashboard();
                        });
                    }

                    // Update Sidebar Name
                    const profile = ProfileManager.getProfile();
                    if (profile.name) {
                        document.getElementById('vendorName').textContent = profile.name;
                        document.getElementById('vendorDisplay').textContent = profile.name;

                        // Populate Settings
                        if (document.getElementById('vSetStoreName')) document.getElementById('vSetStoreName').value = profile.name;
                        if (document.getElementById('vSetEmail')) document.getElementById('vSetEmail').value = localStorage.getItem('newketUserEmail') || profile.email;
                    }

                    // Handle Settings Form
                    const settingsForm = document.getElementById('vendorSettingsForm');
                    if (settingsForm) {
                        settingsForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const newProfile = {
                                ...ProfileManager.getProfile(),
                                name: document.getElementById('vSetStoreName').value,
                                email: document.getElementById('vSetEmail').value
                            };
                            ProfileManager.saveProfile(newProfile);
                            showToast('Paramètres de la boutique enregistrés !', 'success');

                            // Refresh UI
                            document.getElementById('vendorName').textContent = newProfile.name;
                            document.getElementById('vendorDisplay').textContent = newProfile.name;
                        });
                    }

                    // Listen for updates
                    window.addEventListener('withdrawalsUpdated', () => {
                        if (!document.getElementById('tab-gains').classList.contains('hidden')) {
                            renderVendorGains();
                        }
                    });
                });

                function initVendorDashboard() {
                    renderVendorDashboard();
                }

                function renderVendorDashboard() {
                    const email = localStorage.getItem('newketUserEmail');
                    const stats = OrderManager.getVendorStats(email);

                    // Update Stats Slates
                    document.getElementById('vendorTotalSales').textContent = CurrencyManager.formatPrice(stats.netGains);
                    document.getElementById('vendorOrders').textContent = stats.totalOrders;

                    const myProducts = ProductManager.getProducts().filter(p => p.supplier_email === email);
                    document.getElementById('vendorProducts').textContent = myProducts.length;

                    // Render Recent Orders
                    const ordersTable = document.getElementById('vendor-recent-orders');
                    if (stats.recentOrders.length === 0) {
                        ordersTable.innerHTML = `<tr><td colspan="4" class="py-12 text-center text-sm text-gray-400">Aucune commande pour le moment</td></tr>`;
                    } else {
                        ordersTable.innerHTML = stats.recentOrders.map(o => `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="py-4 font-bold text-xs uppercase tracking-wider">#${o.id.substring(0, 6)}</td>
                            <td class="py-4 text-sm text-gray-600">${o.customer?.name || o.customer_name || 'Client'}</td>
                            <td class="py-4">
                                ${o.phone_number ? `
                                    <a href="tel:${o.phone_number}" class="text-[10px] font-black bg-gray-100 px-2 py-1 rounded-md hover:bg-black hover:text-white transition-all inline-flex items-center gap-1">
                                        <iconify-icon icon="solar:phone-bold" width="10"></iconify-icon>
                                        ${o.phone_number}
                                    </a>
                                ` : '<span class="text-gray-300">-</span>'}
                            </td>
                            <td class="py-4 font-black">${CurrencyManager.formatPrice(o.total)}</td>
                            <td class="py-4">
                                <span class="px-2 py-0.5 rounded-full text-[9px] font-bold ${getStatusColor(o.status)}">${o.status}</span>
                            </td>
                        </tr>
                `).join('');
                    }

                    // Render Chart
                    renderSalesChart(stats.chartData);

                    // Activity feed handled by main.js logic generally or locally:
                    const feed = document.getElementById('vendor-activity-feed');
                    if (feed) {
                        const activities = ActivityManager.getRecentActivity(6);
                        feed.innerHTML = activities.length ? activities.map(a => `
                            <div class="flex items-start gap-4 p-4 border border-gray-50 rounded-2xl">
                                <div class="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center text-sm">
                                    <iconify-icon icon="${a.type === 'stock' ? 'solar:box-bold' : 'solar:notification-bold'}" width="20"></iconify-icon>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-gray-900">${a.text}</p>
                                    <p class="text-[10px] font-black text-gray-400 uppercase">${ActivityManager.formatTime(a.time)}</p>
                                </div>
                            </div>
                        `).join('') : '<p class="text-sm text-gray-400 py-4 col-span-full text-center">Aucune activité.</p>';
                    }
                }

                function getStatusColor(status) {
                    if (status === 'Livré') return 'bg-green-50 text-green-600';
                    if (status === 'Annulé') return 'bg-red-50 text-red-600';
                    return 'bg-blue-50 text-blue-600';
                }

                function renderSalesChart(chartData) {
                    const ctx = document.getElementById('salesChart');
                    if (!ctx) return;
                    if (salesChart) salesChart.destroy();
                    salesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                label: 'Ventes',
                                data: chartData.data,
                                borderColor: '#000000',
                                backgroundColor: 'rgba(0,0,0,0.02)',
                                borderWidth: 3, tension: 0.4, fill: true,
                                pointBackgroundColor: '#000000', pointRadius: 4
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                                x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                            }
                        }
                    });
                }

                function renderVendorProducts() {
                    const email = localStorage.getItem('newketUserEmail');
                    const myProducts = ProductManager.getProducts().filter(p => p.supplier_email === email);
                    const grid = document.getElementById('vendor-products-grid');
                    grid.innerHTML = myProducts.length ? myProducts.map(p => `
                        <div class="glass-panel p-4 flex flex-col group">
                            <div class="aspect-square bg-gray-50 rounded-xl mb-3 overflow-hidden relative">
                                 <img src="${p.image}" class="w-full h-full object-contain p-4 group-hover:scale-110 transition-transform">
                            </div>
                            <h3 class="font-bold text-sm mb-1 truncate">${p.name}</h3>
                            <div class="flex items-center justify-between text-xs mt-auto">
                                <span class="font-black">${CurrencyManager.formatPrice(p.price)}</span>
                                <span class="text-gray-400">Stock: ${p.stock || 0}</span>
                            </div>
                        </div>
                    `).join('') : '<div class="col-span-full py-12 text-center text-gray-400">Aucun produit.</div>';
                }

                function renderVendorGains() {
                    const email = localStorage.getItem('newketUserEmail');
                    const stats = OrderManager.getVendorStats(email);

                    document.getElementById('gains-available').textContent = CurrencyManager.formatPrice(stats.availableBalance);
                    document.getElementById('gains-pending').textContent = CurrencyManager.formatPrice(stats.pendingWithdrawals);
                    document.getElementById('gains-commission').textContent = CurrencyManager.formatPrice(stats.commission);

                    // Update payout history
                    const historyBody = document.getElementById('payout-history-body');
                    if (stats.payouts && stats.payouts.length > 0) {
                        historyBody.innerHTML = stats.payouts.map(w => `
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="py-4 text-xs font-medium">${new Date(w.date).toLocaleDateString('fr-FR')}</td>
                                <td class="py-4 font-black">${CurrencyManager.formatPrice(w.amount)}</td>
                                <td class="py-4 text-xs">${w.method}</td>
                                <td class="py-4">
                                    <span class="px-2 py-0.5 rounded-full text-[9px] font-bold ${w.status === 'Approuvé' ? 'bg-green-50 text-green-600' : 'bg-amber-50 text-amber-600'}">${w.status}</span>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        historyBody.innerHTML = `<tr><td colspan="4" class="py-8 text-center text-xs text-gray-400">Aucun retrait effectué</td></tr>`;
                    }

                    // Update modal max
                    document.getElementById('maxAvailableWithdraw').textContent = CurrencyManager.formatPrice(stats.availableBalance);
                }

                // Withdrawal Modal Functions
                function openWithdrawalModal() {
                    const email = localStorage.getItem('newketUserEmail');
                    const stats = OrderManager.getVendorStats(email);
                    if (stats.availableBalance <= 0) {
                        showToast("Votre solde est insuffisant pour un retrait.", "info");
                        return;
                    }
                    document.getElementById('withdrawalModal').classList.remove('hidden');
                    document.getElementById('maxAvailableWithdraw').textContent = CurrencyManager.formatPrice(stats.availableBalance);
                }

                function closeWithdrawalModal() {
                    document.getElementById('withdrawalModal').classList.add('hidden');
                }

                function selectWithdrawMethod(method) {
                    selectedWithdrawMethod = method;
                    document.querySelectorAll('.withdraw-method-btn').forEach(btn => btn.classList.remove('border-black', 'bg-black/5'));
                    if (method === 'M-Pesa') document.getElementById('btn-mpesa').classList.add('border-black', 'bg-black/5');
                    if (method === 'Orange Money') document.getElementById('btn-orange').classList.add('border-black', 'bg-black/5');
                }

                async function submitWithdrawal() {
                    const amountStr = document.getElementById('withdrawAmount').value;
                    const phone = document.getElementById('withdrawPhone').value;
                    const amount = parseFloat(amountStr);
                    const email = localStorage.getItem('newketUserEmail');
                    const stats = OrderManager.getVendorStats(email);

                    if (!amount || amount <= 0) {
                        showToast("Veuillez entrer un montant valide.", "error");
                        return;
                    }
                    if (amount > stats.availableBalance) {
                        showToast("Montant supérieur au solde disponible.", "error");
                        return;
                    }
                    if (!selectedWithdrawMethod) {
                        showToast("Veuillez choisir une méthode de retrait.", "error");
                        return;
                    }
                    if (!phone || phone.length < 9) {
                        showToast("Veuillez entrer un numéro de téléphone valide.", "error");
                        return;
                    }

                    document.getElementById('btnSubmitWithdrawal').disabled = true;
                    document.getElementById('btnSubmitWithdrawal').innerHTML = '<iconify-icon icon="line-md:loading-twotone-loop" width="20"></iconify-icon> Traitement...';

                    try {
                        const success = await OrderManager.requestWithdrawal({
                            supplier_email: email,
                            amount: amount,
                            method: selectedWithdrawMethod,
                            phone_number: phone
                        });

                        if (success) {
                            showToast("Demande de retrait envoyée avec succès !", "success");
                            closeWithdrawalModal();
                            renderVendorGains();
                            ActivityManager.log(`Demande de retrait de ${CurrencyManager.formatPrice(amount)} envoyée`, 'finance');
                        } else {
                            showToast("Erreur lors de l'envoi de la demande.", "error");
                        }
                    } catch (error) {
                        console.error("Withdrawal error:", error);
                        showToast("Une erreur est survenue.", "error");
                    } finally {
                        document.getElementById('btnSubmitWithdrawal').disabled = false;
                        document.getElementById('btnSubmitWithdrawal').innerHTML = 'Confirmer la demande <iconify-icon icon="solar:arrow-right-bold" width="20"></iconify-icon>';
                    }
                }
            </script>
</body>

</html>