<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" sizes="512x512" href="../Images/LOGO NEWKET.png">
    <link rel="icon" type="image/png" href="../Images/LOGO NEWKET.png">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NewKet">
    <title>Profil Utilisateur | NewKet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/supabase-adapter.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1.5rem;
        }

        .activity-dot {
            position: relative;
        }

        .activity-dot::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 2rem;
            bottom: -1rem;
            width: 2px;
            background: #e2e8f0;
            transform: translateX(-50%);
        }

        .activity-item:last-child .activity-dot::after {
            display: none;
        }
    </style>
</head>

<body class="text-gray-900">
    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 bg-white/80 backdrop-blur-md border-b border-gray-100">
        <div class="max-w-[1800px] mx-auto px-4 sm:px-8 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="window.close()"
                    class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 hover:text-black hover:bg-gray-100 transition-colors">
                    <iconify-icon icon="solar:arrow-left-bold" width="20"></iconify-icon>
                </button>
                <div class="h-6 w-px bg-gray-200"></div>
                <h1 class="text-xl font-black tracking-tight" id="headerTitle">Profil Utilisateur</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="roleBadge"
                    class="px-3 py-1 bg-gray-100 text-[10px] font-black uppercase rounded-full tracking-widest text-gray-400">Rôle</span>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-4 sm:px-6 pt-24 pb-12 space-y-8">
        <!-- Top Section: Profile & Stats -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Profile Card -->
            <div class="lg:col-span-1 space-y-6">
                <div class="glass-panel p-8 text-center space-y-4">
                    <div class="w-24 h-24 rounded-full bg-black mx-auto flex items-center justify-center text-3xl font-black text-white shadow-2xl"
                        id="userAvatar">U</div>
                    <div>
                        <h2 class="text-2xl font-black text-gray-900 tracking-tight" id="userName">Chargement...</h2>
                        <p class="text-gray-500 font-medium" id="userEmail">email@example.com</p>
                    </div>
                    <div class="pt-4 flex justify-center gap-4 border-t border-gray-50">
                        <div class="text-center">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Membre depuis</p>
                            <p class="font-bold text-gray-900" id="joinDate">N/A</p>
                        </div>
                    </div>
                    <button onclick="window.print()"
                        class="w-full py-3 bg-gray-50 text-gray-900 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-100 transition-colors">
                        <iconify-icon icon="solar:printer-bold" width="18"></iconify-icon>
                        Imprimer le rapport
                    </button>
                </div>

                <!-- Activity Feed -->
                <div class="glass-panel p-6 space-y-6">
                    <h3 class="font-black text-gray-900 flex items-center gap-2">
                        <iconify-icon icon="solar:bell-bing-bold" width="20" class="text-orange-500"></iconify-icon>
                        Activité Récente
                    </h3>
                    <div id="activityFeed" class="space-y-6">
                        <!-- Activity Items -->
                    </div>
                </div>
            </div>

            <!-- Stats & Lists -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="glass-panel p-6 border-b-4 border-blue-500">
                        <p class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-1" id="stat1Label">
                            Commandes</p>
                        <div class="text-3xl font-black text-gray-900" id="stat1Value">0</div>
                    </div>
                    <div class="glass-panel p-6 border-b-4 border-green-500">
                        <p class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-1" id="stat2Label">
                            Dépenses</p>
                        <div class="text-3xl font-black text-gray-900" id="stat2Value">0</div>
                    </div>
                    <div class="glass-panel p-6 border-b-4 border-purple-500">
                        <p class="text-[10px] font-black uppercase tracking-widest text-gray-400 mb-1" id="stat3Label">
                            Moyenne</p>
                        <div class="text-3xl font-black text-gray-900" id="stat3Value">0</div>
                    </div>
                </div>

                <!-- Main Content List (Orders or Products) -->
                <div class="glass-panel overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-lg font-black text-gray-900 flex items-center gap-2" id="listTitle">
                            Historique
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left" id="dataTable">
                            <thead>
                                <tr class="bg-gray-50/50">
                                    <th class="p-4 text-[10px] font-black uppercase tracking-widest text-gray-400">Date
                                    </th>
                                    <th class="p-4 text-[10px] font-black uppercase tracking-widest text-gray-400">Réf /
                                        Nom</th>
                                    <th class="p-4 text-[10px] font-black uppercase tracking-widest text-gray-400">
                                        Détails</th>
                                    <th
                                        class="p-4 text-[10px] font-black uppercase tracking-widest text-gray-400 text-right">
                                        Montant</th>
                                </tr>
                            </thead>
                            <tbody id="dataBody" class="divide-y divide-gray-100">
                                <!-- Data injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="emptyState" class="hidden p-12 text-center text-gray-400">
                        <iconify-icon icon="solar:box-linear" width="48" class="mb-4 text-gray-200"></iconify-icon>
                        <p>Aucune donnée disponible pour cet utilisateur.</p>
                    </div>
                </div>

                <!-- If Supplier: Show Products too -->
                <div id="supplierProductsSection" class="hidden glass-panel overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="text-lg font-black text-gray-900 flex items-center gap-2">
                            Catalogue du vendeur
                        </h3>
                    </div>
                    <div class="p-6 grid grid-cols-2 sm:grid-cols-3 gap-4" id="productsGrid">
                        <!-- Products injected here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/main.js"></script>
    <script>
        async function loadUserDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');

            if (!email) {
                document.getElementById('userName').textContent = "Utilisateur introuvable";
                return;
            }

            // Get User from Database
            const users = UserManager.getUsers();
            let user = users.find(u => u.email === email);

            // If not found in users list (maybe he's just an order customer), infer from order
            const allOrders = OrderManager.getOrders();
            const clientOrders = allOrders.filter(o =>
                (o.customer && o.customer.email === email) ||
                o.customer_email === email ||
                o.user_email === email
            );

            if (!user && clientOrders.length > 0) {
                user = {
                    name: clientOrders[0].customer?.name || clientOrders[0].customer_name,
                    email: email,
                    role: 'customer',
                    dateJoined: clientOrders[clientOrders.length - 1].date
                };
            }

            if (!user) {
                document.getElementById('userName').textContent = "Utilisateur inconnu";
                return;
            }

            const role = user.role || 'customer';

            // UI Setup
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userAvatar').textContent = user.name.substring(0, 2).toUpperCase();
            document.getElementById('joinDate').textContent = new Date(user.dateJoined).toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });

            const badge = document.getElementById('roleBadge');
            badge.textContent = role === 'supplier' ? 'Vendeur / Fournisseur' : 'Client / Acheteur';
            badge.className = `px-3 py-1 text-[10px] font-black uppercase rounded-full tracking-widest ${role === 'supplier' ? 'bg-blue-100 text-blue-600' : 'bg-green-100 text-green-600'}`;

            if (role === 'supplier') {
                renderSupplierView(user, allOrders);
            } else {
                renderCustomerView(user, clientOrders);
            }

            renderActivityFeed(user, clientOrders);
        }

        function renderCustomerView(user, orders) {
            const validOrders = orders.filter(o => o.status !== 'Annulé' && o.status !== 'cancelled').sort((a, b) => new Date(b.date) - new Date(a.date));
            const totalSpent = validOrders.reduce((sum, o) => sum + (o.total || 0), 0);

            document.getElementById('stat1Label').textContent = "Total Commandes";
            document.getElementById('stat1Value').textContent = validOrders.length;
            document.getElementById('stat2Label').textContent = "Dépenses Totales";
            document.getElementById('stat2Value').textContent = CurrencyManager.formatPrice(totalSpent);
            document.getElementById('stat3Label').textContent = "Panier Moyen";
            document.getElementById('stat3Value').textContent = validOrders.length > 0 ? CurrencyManager.formatPrice(totalSpent / validOrders.length) : '0';

            document.getElementById('listTitle').textContent = "Historique des achats";

            const tbody = document.getElementById('dataBody');
            if (orders.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }

            tbody.innerHTML = orders.map(o => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="p-4 text-xs font-bold text-gray-400">${new Date(o.date).toLocaleDateString()}</td>
                    <td class="p-4 font-black text-gray-900">#${o.id}</td>
                    <td class="p-4">
                        <span class="px-2 py-0.5 rounded-full text-[9px] font-black uppercase bg-gray-100 text-gray-500">${o.status}</span>
                    </td>
                    <td class="p-4 text-right font-black text-gray-900">${CurrencyManager.formatPrice(o.total)}</td>
                </tr>
            `).join('');
        }

        function renderSupplierView(user, allOrders) {
            const products = ProductManager.getProducts().filter(p => p.supplier_email === user.email);

            // Filter orders that contain this supplier's products
            const supplierRevenueOrders = allOrders.filter(o =>
                (o.items || []).some(item => products.some(p => p.id === item.id))
            );

            const totalGross = supplierRevenueOrders.reduce((sum, o) => {
                const supplierTotal = (o.items || []).filter(item => products.some(p => p.id === item.id))
                    .reduce((s, it) => s + (it.price * it.quantity), 0);
                return sum + supplierTotal;
            }, 0);

            document.getElementById('stat1Label').textContent = "Produits en vente";
            document.getElementById('stat1Value').textContent = products.length;
            document.getElementById('stat2Label').textContent = "Volume de Ventes";
            document.getElementById('stat2Value').textContent = CurrencyManager.formatPrice(totalGross);
            document.getElementById('stat3Label').textContent = "Commission (10%)";
            document.getElementById('stat3Value').textContent = CurrencyManager.formatPrice(totalGross * 0.1);

            document.getElementById('listTitle').textContent = "Commandes reçues";

            const tbody = document.getElementById('dataBody');
            if (supplierRevenueOrders.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                tbody.innerHTML = supplierRevenueOrders.map(o => {
                    const mine = (o.items || []).filter(item => products.some(p => p.id === item.id));
                    const subtotal = mine.reduce((s, it) => s + (it.price * it.quantity), 0);
                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="p-4 text-xs font-bold text-gray-400">${new Date(o.date).toLocaleDateString()}</td>
                            <td class="p-4">
                                <div class="font-black text-gray-900">#${o.id}</div>
                                <div class="text-[10px] text-gray-400 uppercase font-bold">${o.customer_name || 'Client'}</div>
                            </td>
                            <td class="p-4">
                                <div class="text-[10px] text-gray-500 font-bold">${mine.length} art. parmis ${o.items.length}</div>
                            </td>
                            <td class="p-4 text-right font-black text-gray-900">${CurrencyManager.formatPrice(subtotal)}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Products Grid
            document.getElementById('supplierProductsSection').classList.remove('hidden');
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = products.map(p => `
                <div class="group relative bg-gray-50 rounded-xl overflow-hidden border border-transparent hover:border-gray-200 transition-all p-3">
                    <img src="../${p.image}" class="w-full aspect-square object-contain mb-3">
                    <div class="font-bold text-xs truncate">${p.name}</div>
                    <div class="text-[10px] text-gray-400 font-black">${CurrencyManager.formatPrice(p.price)}</div>
                </div>
            `).join('');
        }

        function renderActivityFeed(user, orders) {
            const feed = document.getElementById('activityFeed');
            const items = [];

            // 1. Join
            items.push({
                type: 'join',
                title: 'Inscription sur la plateforme',
                desc: 'Compte créé avec succès.',
                date: user.dateJoined,
                icon: 'solar:user-plus-bold',
                color: 'text-blue-500'
            });

            // 2. Orders
            orders.forEach(o => {
                items.push({
                    type: 'order',
                    title: `Commande #${o.id}`,
                    desc: user.role === 'supplier' ? 'Vendu un ou plusieurs articles.' : 'Achat effectué.',
                    date: o.date,
                    icon: 'solar:cart-large-bold',
                    color: 'text-green-500'
                });
            });

            // Sort desc
            items.sort((a, b) => new Date(b.date) - new Date(a.date));

            feed.innerHTML = items.map(item => `
                <div class="activity-item flex gap-4">
                    <div class="activity-dot flex-shrink-0">
                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center ${item.color} shadow-sm border border-white">
                            <iconify-icon icon="${item.icon}" width="16"></iconify-icon>
                        </div>
                    </div>
                    <div class="flex-1 pb-4">
                        <p class="text-sm font-bold text-gray-900">${item.title}</p>
                        <p class="text-[11px] text-gray-500 font-medium">${item.desc}</p>
                        <p class="text-[9px] font-black uppercase tracking-widest text-gray-300 mt-1">${new Date(item.date).toLocaleString('fr-FR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                </div>
            `).join('');
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.newketInitialized) {
                loadUserDetails();
            } else {
                window.addEventListener('newketInitialized', loadUserDetails);
            }
        });
    </script>
</body>

</html>